<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultation - myBru</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <nav class="site-nav">
            <button id="nav-toggle" class="nav-toggle" aria-expanded="false" aria-label="Toggle navigation">
                <span class="hamburger"></span>
            </button>
            <ul class="nav-menu">
                <li><a href="home.html">Home</a></li>
                <li><a href="generic.html">Generic Brews</a></li>
                <li id="nav-membership"><a href="membership.html" >Membership</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="orders.html">Orders</a></li>
            </ul>
        </nav>

        <header>
            <div class="header-top">
                <div>
                    <h1>myBru <small>with a touch of couture!</small></h1>
                    <p>Master the Art of Intentional Brewing for different and diverse occasions, mood strikes, special craving, body chemistry, health target and allergies. Whether you are looking for rich tea experience; wellness in a cup of tea or just to unwind, myBrub guides your flavorful journey from cup to consciousness.</p>
                </div>
                <div class="header-right">
                    <div class="cart-container">
                        <a href="cart.html" id="cart-icon" title="View Cart">
                            <img src="images/cart-icon.png" alt="Cart" width="30">
                            <span id="cart-counter">0</span>
                        </a>
                    </div>
                    <div class="auth-section">
                        <div id="user-menu" class="user-menu" style="display: none;">
                            <span id="user-name" class="user-name"></span>
                            <button id="logout-btn" class="btn-logout">Logout</button>
                        </div>
                        <div id="auth-links" class="auth-links">
                            <a href="login.html" class="btn-login">Login</a>
                            <a href="signup.html" class="btn-signup">Sign Up</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- nav moved above header for mobile-first ordering -->

        <main>
            <section id="registration">
                <h2>JOIN THE CARNIVAL!</h2>
                <form id="consult-form" action="/register" method="post" enctype="multipart/form-data">
                    <input type="hidden" id="membership-id" name="membership_id" value="">
                    <input type="hidden" id="membership-tier" name="membership_tier" value="">
                    <div>
                        <label for="photo-upload">Upload Photo:</label>
                        <input type="file" id="photo-upload" name="photo">
                    </div>
                    <div>
                        <label for="first-name">First Name:</label>
                        <input type="text" id="first-name" name="first_name">
                    </div>
                    <div>
                        <label for="other-names">Other Names:</label>
                        <input type="text" id="other-names" name="other_names">
                    </div>
                    <div>
                        <label for="gender">Gender:</label>
                        <select id="gender" name="gender">
                            <option value="">--Please choose an option--</option>
                            <option value="female">Female</option>
                            <option value="male">Male</option>
                            <option value="non-binary">Non-binary</option>
                            <option value="prefer-not-to-say">Prefer not to say</option>
                        </select>
                    </div>
                    <div>
                        <label for="dob">Date of Birth:</label>
                        <input type="date" id="dob" name="dob">
                    </div>
                    <div>
                        <label for="city">City:</label>
                        <input type="text" id="city" name="city">
                    </div>
                    <div>
                        <label for="state">State:</label>
                        <input type="text" id="state" name="state">
                    </div>
                     <div>
                        <label for="country">Country:</label>
                        <input type="text" id="country" name="country">
                    </div>
                    <div>
                        <label for="whatsapp">WhatsApp:</label>
                        <input type="tel" id="whatsapp" name="whatsapp" placeholder="+1 (555) 555-5555">
                    </div>
                    <div>
                        <label for="email">e-mail:</label>
                        <input type="email" id="email" name="email">
                    </div>
                    <div>
                        <label for="phone">Phone:</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                    <div>
                        <label for="referral">How you got to know about myBru?</label>
                        <select id="referral" name="referral">
                             <option value="">--Please choose an option--</option>
                             <option value="social-media">Social Media</option>
                             <option value="search-engine">Search Engine</option>
                             <option value="friend">Friend/Family</option>
                             <option value="member-referral">Member Referral</option>
                        </select>
                    </div>

                    <fieldset>
                        <legend>INTEREST</legend>
                        <p>Category:</p>
                        <input type="checkbox" id="interest-social" name="interest" value="social"><label for="interest-social">Social</label>
                        <input type="checkbox" id="interest-business" name="interest" value="business"><label for="interest-business">Business</label>
                        <input type="checkbox" id="interest-health" name="interest" value="health"><label for="interest-health">Health</label>
                        <p>Plan(s):</p>
                        <input type="checkbox" id="plan-bespoke" name="plan" value="bespoke"><label for="plan-bespoke">Bespoke</label>
                        <input type="checkbox" id="plan-protocols" name="plan" value="natural_protocols"><label for="plan-protocols">Natural Protocols</label>
                    </fieldset>

                    <fieldset>
                        <legend>Health Information</legend>
                        <div>
                            <label for="blood-group">Blood Group Type:</label>
                            <select id="blood-group" name="blood_group">
                                <option value="">--Select--</option>
                                <option value="A+">A+</option> <option value="A-">A-</option>
                                <option value="B+">B+</option> <option value="B-">B-</option>
                                <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                                <option value="O+">O+</option> <option value="O-">O-</option>
                            </select>
                        </div>
                        <div><label for="allergies">Allergies (if any):</label><textarea id="allergies" name="allergies"></textarea></div>
                        <div><label for="dietary">Dietary likes/dislikes:</label><textarea id="dietary" name="dietary"></textarea></div>
                        <div><label for="medical">Medical Conditions:</label><textarea id="medical" name="medical"></textarea></div>
                        <div><label for="health-targets">Health Targets:</label><textarea id="health-targets" name="health_targets"></textarea></div>
                    </fieldset>

                    <button type="submit">SUBMIT</button>
                </form>
                
                <!-- Selection overlay (film) shown when user comes from membership page -->
                <div id="membership-film" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
                    <div style="background:white; padding:20px; border-radius:8px; max-width:520px; width:90%; text-align:center;">
                        <h3 id="film-title">Selected Membership</h3>
                        <p id="film-desc">You selected <strong id="film-membership"></strong>.</p>
                        <p style="margin-top:12px;">Fill the registration below to proceed with subscribing.</p>
                        <div style="margin-top:18px; display:flex; gap:10px; justify-content:center;">
                            <button id="film-continue" style="padding:8px 14px; background:#8B4513; color:white; border:none; border-radius:6px;">Continue</button>
                            <button id="film-cancel" style="padding:8px 14px; background:#ccc; border:none; border-radius:6px;">Cancel</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="consultation-info">
                <h2>BOOK A CONSULTATION</h2>
                <p>MyBru Wellness Ambassador will contact you for detailed, one-on-one session, to find out if you qualify for Membership. Together, we’ll go over your survey results, ask clarifying questions, with a view to provide you a customized blueprint that matches your plan.</p>
                <p>During the call, we’ll discuss your interest, current health concerns, any previous diagnoses, the supplements or natural protocols you’re currently following, and your personal health goals. MyBru will carefully review your interest, choice and target before customizing your plan.</p>                 
                <p><strong>Please note:</strong> While we make every effort to help guide you, some cases are more complex than others, so we may not be able to accept everyone. If you’ve qualified for Membership, congratulations—you would be awarded a registration number. This is also your opportunity to ask questions and get practical, nutritional guidance.</p>
                <p><em>Since our service is focused strictly on nutritional coaching, no doctor–patient relationship is established, and not all individuals will qualify for the program. Our approach is a Total Body & Mind Method to help you improve your wellbeing. Appointments are subject to availability and may change with notice.</em></p>
            </section>
        </main>
    </div>
    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="consultation.html">Book a Consultation</a></li>
                        <li><a href="subscription.html">Subscriptions</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-copyright">
                <p>&copy; 2024 myBru. All rights reserved.</p>
            </div>
        </div>
    </footer>
    <script src="js/main.js"></script>
    <script>
        // Consultation page: prefill membership and submit to API (update profile + create subscription)
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const membershipId = params.get('membership_id');
            const tier = params.get('tier');

            // Try localStorage fallback
            let pending = null;
            try { pending = JSON.parse(localStorage.getItem('pending_membership') || 'null'); } catch (e) { pending = null; }
            const selId = membershipId || (pending && pending.id);
            const selTier = tier || (pending && pending.tier);

            if (selId) {
                // Show film overlay
                const film = document.getElementById('membership-film');
                const filmMembership = document.getElementById('film-membership');
                const filmTitle = document.getElementById('film-title');
                filmMembership.textContent = selTier || ('#' + selId);
                filmTitle.textContent = 'Selected Membership';
                film.style.display = 'flex';

                // Set hidden inputs
                document.getElementById('membership-id').value = selId;
                document.getElementById('membership-tier').value = selTier || '';

                document.getElementById('film-continue').addEventListener('click', () => {
                    film.style.display = 'none';
                });
                document.getElementById('film-cancel').addEventListener('click', () => {
                    // clear selection and hide
                    try { localStorage.removeItem('pending_membership'); } catch (e) {}
                    film.style.display = 'none';
                });
            }

            const form = document.getElementById('consult-form');
            form.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Please log in before subscribing.');
                    window.location.href = 'login.html';
                    return;
                }

                const formData = new FormData(form);
                // Map form fields to profile fields
                const bio = (formData.get('other_names') || '') + ' ' + (formData.get('first_name') || '');
                const teaPrefs = [];
                // collect checkbox interests as tea_preferences
                form.querySelectorAll('input[name="interest"]:checked').forEach(cb => teaPrefs.push(cb.value));
                const health_goals = formData.get('health_targets') || formData.get('health_targets') || '';

                try {
                    // 1) get or create profile
                    const profileResp = await fetch('https://tjib26.pythonanywhere.com/api/profiles/my_profile/', { headers: { 'Authorization': `Token ${token}` } });
                    if (!profileResp.ok) throw new Error('Could not fetch profile');
                    const profile = await profileResp.json();

                    // 2) patch profile with collected data
                    const patchResp = await fetch(`https://tjib26.pythonanywhere.com/api/profiles/${profile.id}/`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` },
                        body: JSON.stringify({ bio: bio.trim(), tea_preferences: teaPrefs, health_goals })
                    });

                    if (!patchResp.ok) {
                        console.warn('Profile patch failed', await patchResp.text());
                    }

                    // 3) create subscription
                    const membership_id = document.getElementById('membership-id').value;
                    if (!membership_id) {
                        alert('No membership selected. Please choose a membership first.');
                        return;
                    }

                    const subResp = await fetch('https://tjib26.pythonanywhere.com/api/subscriptions/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` },
                        body: JSON.stringify({ membership_id: membership_id })
                    });

                    if (!subResp.ok) {
                        const err = await subResp.json().catch(() => ({}));
                        alert('Could not create subscription: ' + (err.error || subResp.statusText));
                        return;
                    }

                    const subscription = await subResp.json();
                    // Save membership locally for quick UI update
                    try { localStorage.setItem('user-membership', JSON.stringify(subscription.membership || {})); } catch (e) {}
                    alert('Subscription created successfully. Thank you!');
                    // clear pending selection
                    try { localStorage.removeItem('pending_membership'); } catch (e) {}
                    window.location.href = 'membership.html';
                } catch (err) {
                    console.error('Subscription flow error', err);
                    alert('An error occurred while creating your subscription. Please try again.');
                }
            });
        });
    </script>
</body>
</html>