<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membership Plans - myBru</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .membership-section {
            padding: 40px 20px;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
        }

        .membership-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .membership-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .membership-header h2 {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #333;
        }

        .membership-header p {
            font-size: 1.1em;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        .membership-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }

        .membership-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .membership-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .membership-card.featured {
            border: 3px solid #8B4513;
            transform: scale(1.05);
        }

        .membership-badge {
            display: inline-block;
            background: #8B4513;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 15px;
            width: fit-content;
        }

        .membership-card.featured .membership-badge {
            background: #D2B48C;
            color: #333;
        }

        .membership-name {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .membership-price {
            font-size: 2.2em;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 5px;
        }

        .membership-price .currency {
            font-size: 0.7em;
        }

        .membership-period {
            color: #999;
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .membership-description {
            color: #666;
            margin-bottom: 25px;
            flex-grow: 1;
            line-height: 1.6;
        }

        .membership-features {
            list-style: none;
            margin-bottom: 25px;
            padding: 0;
        }

        .membership-features li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            color: #555;
            display: flex;
            align-items: center;
        }

        .membership-features li:last-child {
            border-bottom: none;
        }

        .membership-features li:before {
            content: "âœ“";
            color: #8B4513;
            font-weight: bold;
            margin-right: 12px;
            font-size: 1.2em;
        }

        .membership-cta {
            margin-top: auto;
        }

        .btn-subscribe {
            width: 100%;
            padding: 12px 20px;
            background: #8B4513;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-subscribe:hover {
            background: #6b3410;
        }

        .btn-subscribe.current {
            background: #ccc;
            cursor: not-allowed;
        }

        .current-badge {
            background: #ccc;
            color: #666;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            text-align: center;
            margin-top: 10px;
        }

        .user-status {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .user-status h3 {
            margin-top: 0;
            color: #333;
        }

        .status-detail {
            margin: 10px 0;
            color: #666;
        }

        .status-detail strong {
            color: #333;
        }

        @media (max-width: 768px) {
            .membership-header h2 {
                font-size: 1.8em;
            }

            .membership-card.featured {
                transform: scale(1);
            }

            .membership-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="site-nav">
            <button id="nav-toggle" class="nav-toggle" aria-expanded="false" aria-label="Toggle navigation">
                <span class="hamburger"></span>
            </button>
            <ul class="nav-menu">
                <li><a href="home.html">Home</a></li>
                <li><a href="generic.html">Generic Brews</a></li>
                <li><a href="membership.html" class="nav-active">Membership</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="cart.html">Cart</a></li>
            </ul>
        </nav>

        <header>
            <div class="header-top">
                <div>
                    <h1>myBru <small>with a touch of couture!</small></h1>
                    <p>Master the Art of Intentional Brewing for different and diverse occasions, mood strikes, special craving, body chemistry, health target and allergies.</p>
                </div>
                <div class="header-right">
                    <div class="cart-container">
                        <a href="cart.html" id="cart-icon" title="View Cart">
                            <img src="images/cart-icon.png" alt="Cart" width="30">
                            <span id="cart-counter">0</span>
                        </a>
                    </div>
                    <div class="auth-section">
                        <div id="user-menu" class="user-menu" style="display: none;">
                            <span id="user-name" class="user-name"></span>
                            <button id="logout-btn" class="btn-logout">Logout</button>
                        </div>
                        <div id="auth-links" class="auth-links">
                            <a href="login.html" class="btn-login">Login</a>
                            <a href="signup.html" class="btn-signup">Sign Up</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <section class="membership-section">
                <div class="membership-container">
                    <div class="membership-header">
                        <h2>Choose Your myBru Experience</h2>
                        <p>Unlock personalized tea blending, health protocols, and exclusive benefits tailored to your wellness journey.</p>
                    </div>

                    <div id="user-status" class="user-status" style="display: none;">
                        <!-- Current membership status will be displayed here -->
                    </div>

                    <div class="membership-grid" id="membership-grid">
                        <!-- Membership cards will be loaded here dynamically -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="consultation.html">Book a Consultation</a></li>
                        <li><a href="subscription.html">Subscriptions</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-copyright">
                <p>&copy; 2024 myBru. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = 'https://tjib26.pythonanywhere.com/api';

        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth status and load memberships
            checkAuthStatus();
            await fetchMemberships();
            await fetchUserProfile();
        });

        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Token ${token}`;
            }
            return headers;
        }

        function checkAuthStatus() {
            const user = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('token');
            const userMenu = document.getElementById('user-menu');
            const authLinks = document.getElementById('auth-links');
            const userName = document.getElementById('user-name');

            if (user && token) {
                authLinks.style.display = 'none';
                userMenu.style.display = 'flex';
                userName.textContent = user.username || user.email;
            } else {
                authLinks.style.display = 'flex';
                userMenu.style.display = 'none';
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
        }

        function logout() {
            const token = localStorage.getItem('token');
            if (token) {
                fetch(`${API_URL}/auth/logout/`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                }).then(() => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'home.html';
                });
            }
        }

        async function fetchMemberships() {
            try {
                const resp = await fetch(`${API_URL}/memberships/`);
                if (!resp.ok) throw new Error('Failed to fetch memberships');
                const memberships = await resp.json();
                displayMemberships(memberships);
            } catch (err) {
                console.error('Error fetching memberships:', err);
                document.getElementById('membership-grid').innerHTML = '<p>Failed to load membership plans. Please try again later.</p>';
            }
        }

        async function fetchUserProfile() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const resp = await fetch(`${API_URL}/profiles/my_profile/`, {
                    headers: getAuthHeaders()
                });
                if (resp.ok) {
                    const profile = await resp.json();
                    displayUserStatus(profile);
                }
            } catch (err) {
                console.error('Error fetching profile:', err);
            }
        }

        function displayUserStatus(profile) {
            const statusEl = document.getElementById('user-status');
            if (profile.current_membership) {
                statusEl.style.display = 'block';
                statusEl.innerHTML = `
                    <h3>Your Current Membership</h3>
                    <div class="status-detail">
                        <strong>Tier:</strong> ${profile.current_membership.tier}
                    </div>
                    <div class="status-detail">
                        <strong>Plan:</strong> ${profile.current_membership.name}
                    </div>
                    <div class="status-detail">
                        <strong>Price:</strong> <span class="price" data-amount-ngn="${profile.current_membership.price}"></span>/month
                    </div>
                `;
                if (window.updatePriceElements) window.updatePriceElements();
            } else {
                statusEl.style.display = 'none';
            }
        }

        function displayMemberships(memberships) {
            const grid = document.getElementById('membership-grid');
            const userMembership = JSON.parse(localStorage.getItem('user-membership') || 'null');

            grid.innerHTML = memberships.map((membership, idx) => {
                const isCurrentMembership = userMembership && userMembership.id === membership.id;
                const isFeatured = membership.tier === 'PREMIUM';

                return `
                    <div class="membership-card ${isFeatured ? 'featured' : ''}">
                        <div class="membership-badge">${membership.tier}</div>
                        <h3 class="membership-name">${membership.name}</h3>
                        <div class="membership-price">
                            <span class="price" data-amount-ngn="${membership.price}"></span>
                        </div>
                        <div class="membership-period">/month</div>
                        <p class="membership-description">${membership.description}</p>
                        
                        <ul class="membership-features">
                            ${(() => {
                                // Ensure features is an array before mapping
                                let featuresArr = [];
                                try {
                                    if (Array.isArray(membership.features)) {
                                        featuresArr = membership.features;
                                    } else if (typeof membership.features === 'string') {
                                        // Try parse JSON string, otherwise split by commas/newlines
                                        try {
                                            const parsed = JSON.parse(membership.features);
                                            if (Array.isArray(parsed)) featuresArr = parsed;
                                            else if (typeof parsed === 'object' && parsed !== null) featuresArr = Object.values(parsed);
                                            else featuresArr = [String(parsed)];
                                        } catch (e) {
                                            featuresArr = membership.features.split(/\r?\n|,/).map(s => s.trim()).filter(Boolean);
                                        }
                                    } else if (membership.features && typeof membership.features === 'object') {
                                        featuresArr = Object.values(membership.features);
                                    }
                                } catch (err) {
                                    featuresArr = [];
                                }

                                const items = featuresArr.map(f => `<li>${f}</li>`).join('');
                                const health = membership.includes_health_protocol ? '<li>Personalized Health Protocols</li>' : '';
                                // If price is zero => no customizations available
                                const priceNum = Number(membership.price) || 0;
                                let customizations = '';
                                if (priceNum === 0) {
                                    customizations = '<li>No Customizations</li>';
                                } else {
                                    customizations = membership.max_customizations_per_month > 0 ? `<li>${membership.max_customizations_per_month} Customizations/Month</li>` : '<li>Unlimited Customizations</li>';
                                }
                                return items + health + customizations;
                            })()}
                        </ul>

                        <div class="membership-cta">
                            ${isCurrentMembership ? 
                                `<div class="current-badge">Current Plan</div>` :
                                `<button class="btn-subscribe" onclick="subscribeMembership(${membership.id}, '${membership.tier}')">
                                    Subscribe Now
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');

            // Update price elements after rendering (use global updater if present,
            // otherwise fallback to local NGN formatter)
            ensurePricesDisplayed();
        }

        function ensurePricesDisplayed() {
            if (window.updatePriceElements) {
                try { window.updatePriceElements(); return; } catch (e) { /* fallthrough */ }
            }

            function formatNgn(amount) {
                const n = Number(amount);
                if (isNaN(n)) return String(amount);
                return n.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            document.querySelectorAll('.price[data-amount-ngn]').forEach(el => {
                const v = el.getAttribute('data-amount-ngn');
                if (!el.textContent || el.textContent.trim() === '') {
                    el.textContent = formatNgn(v);
                }
            });
        }

        function subscribeMembership(membershipId, tier) {
            // Store selected membership and navigate to the consultation/subscription form
            const sel = { id: membershipId, tier };
            try { localStorage.setItem('pending_membership', JSON.stringify(sel)); } catch (e) {}
            // Pass via query param as well for convenience
            const q = `?membership_id=${encodeURIComponent(membershipId)}&tier=${encodeURIComponent(tier)}`;
            window.location.href = `consultation.html${q}`;
        }

        async function createSubscription(membershipId) {
            const token = localStorage.getItem('token');
            try {
                const resp = await fetch(`${API_URL}/subscriptions/`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        membership_id: membershipId
                    })
                });

                if (resp.ok) {
                    const subscription = await resp.json();
                    alert('Subscription created successfully! You are now a member.');
                    
                    // Save subscription info locally
                    localStorage.setItem('user-membership', JSON.stringify(subscription.membership));
                    
                    // Refresh page to show updated membership status
                    location.reload();
                } else {
                    const err = await resp.json();
                    alert(`Error: ${err.error || 'Could not create subscription'}`);
                }
            } catch (err) {
                console.error('Subscription error:', err);
                alert('Error creating subscription. Please try again.');
            }
        }
    </script>
    <script src="js/main.js"></script>
</body>
</html>
