<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Processing - myBru</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .payment-container {
            max-width: 500px;
            margin: 80px auto;
            padding: 40px;
            text-align: center;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .payment-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8B4513;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            color: #2e7d32;
            margin: 20px 0;
            font-size: 1.1rem;
        }

        .error-message {
            color: #d32f2f;
            margin: 20px 0;
            font-size: 1.1rem;
        }

        .order-details {
            text-align: left;
            margin: 30px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .order-details p {
            margin: 10px 0;
            font-size: 0.95rem;
        }

        .btn {
            background-color: #8B4513;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #6B3410;
        }

        .btn-secondary {
            background-color: #999;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background-color: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="site-nav">
            <button id="nav-toggle" class="nav-toggle" aria-expanded="false" aria-label="Toggle navigation">
                <span class="hamburger"></span>
            </button>
            <ul class="nav-menu">
                <li><a href="home.html">Home</a></li>
                <li><a href="generic.html">Generic Brews</a></li>
                <li id="nav-membership"><a href="membership.html">Membership</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="orders.html">Orders</a></li>
                <li><a href="cart.html">Cart</a></li>
            </ul>
        </nav>

        <header>
            <h1>myBru <small>with a touch of couture!</small></h1>
            <p>Master the Art of Intentional Brewing</p>
        </header>

        <main>
            <div class="payment-container">
                <h2>Payment Processing</h2>
                <div id="payment-status">
                    <div class="payment-spinner"></div>
                    <p>Processing your payment...</p>
                </div>
                <div id="order-info" style="display: none;"></div>
            </div>
        </main>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h4>myBru</h4>
                    <p>&copy; 2024 myBru. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        const API_URL = 'https://tjib26.pythonanywhere.com/api';

        async function verifyPayment() {
            // Get reference from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const reference = urlParams.get('reference');

            if (!reference) {
                document.getElementById('payment-status').innerHTML = `
                    <div class="error-message">❌ Invalid payment reference</div>
                    <a href="cart.html" class="btn">Return to Cart</a>
                `;
                return;
            }

            try {
                // Verify payment with backend
                const token = localStorage.getItem('token');
                const headers = {
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json'
                };

                const response = await fetch(
                    `${API_URL}/payment/verify/?reference=${encodeURIComponent(reference)}`,
                    { headers }
                );

                if (response.ok) {
                    const data = await response.json();
                    const order = data.order;

                    // Payment successful
                    document.getElementById('payment-status').innerHTML = `
                        <div style="font-size: 3rem; margin: 20px 0;">✅</div>
                        <div class="success-message">Payment Successful!</div>
                        <p>Your order has been created and is being processed.</p>
                    `;

                    document.getElementById('order-info').style.display = 'block';
                    document.getElementById('order-info').innerHTML = `
                        <div class="order-details">
                            <h3 style="margin-top: 0; color: #333;">Order Details</h3>
                            <p><strong>Order ID:</strong> #${order.id}</p>
                            <p><strong>Total Amount:</strong> ₦${parseFloat(order.total_price).toLocaleString('en-NG', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                            <p><strong>Delivery Type:</strong> ${order.delivery_type === 'pickup' ? 'Pickup' : 'Delivery'}</p>
                            ${order.delivery_type === 'pickup' ? `<p><strong>Pickup Location:</strong> ${order.pickup_location || 'To be confirmed'}</p>` : `<p><strong>Delivery Address:</strong> ${order.delivery_address_line1}, ${order.delivery_city}</p>`}
                            <p><strong>Status:</strong> <span style="color: #2e7d32; font-weight: bold;">PAID</span></p>
                        </div>
                        <a href="orders.html" class="btn">View All Orders</a>
                        <a href="home.html" class="btn btn-secondary">Continue Shopping</a>
                    `;

                    // Clear sessionStorage
                    sessionStorage.removeItem('paystack_reference');

                } else {
                    const error = await response.json();
                    document.getElementById('payment-status').innerHTML = `
                        <div style="font-size: 3rem; margin: 20px 0;">❌</div>
                        <div class="error-message">Payment Verification Failed</div>
                        <p>${error.error || 'Could not verify your payment'}</p>
                    `;
                    document.getElementById('order-info').style.display = 'block';
                    document.getElementById('order-info').innerHTML = `
                        <a href="cart.html" class="btn">Return to Cart</a>
                        <a href="checkout.html" class="btn btn-secondary">Retry Checkout</a>
                    `;
                }
            } catch (error) {
                console.error('Payment verification error:', error);
                document.getElementById('payment-status').innerHTML = `
                    <div style="font-size: 3rem; margin: 20px 0;">⚠️</div>
                    <div class="error-message">Payment Processing Error</div>
                    <p>An error occurred while processing your payment</p>
                `;
                document.getElementById('order-info').style.display = 'block';
                document.getElementById('order-info').innerHTML = `
                    <a href="cart.html" class="btn">Return to Cart</a>
                    <a href="checkout.html" class="btn btn-secondary">Retry Checkout</a>
                `;
            }
        }

        // Verify payment when page loads
        document.addEventListener('DOMContentLoaded', verifyPayment);
    </script>
</body>
</html>
